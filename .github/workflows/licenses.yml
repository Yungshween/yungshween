name: Generate Metrics

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  metrics:
    name: "Generate License Graph"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout nexus-ai repository
        uses: actions/checkout@v4
        with:
          repository: Yungshween/nexus-ai
          token: ${{ secrets.NEXUS_PAT }}
          path: nexus-ai

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install uv
          pip install -e .
        working-directory: nexus-ai/backend

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install Node.js dependencies
        run: npm ci
        working-directory: nexus-ai/frontend

      - name: Build frontend
        run: npm run build
        working-directory: nexus-ai/frontend

      - uses: lowlighter/metrics@latest
        with:
          filename: docs/assets/images/metrics/metrics.plugin.licenses.ratio.svg
          token: ${{ secrets.NEXUS_PAT }}
          base: ""
          user: Yungshween
          repo: nexus-ai
          template: repository
          plugin_licenses: yes
          plugin_licenses_setup: |
            bash -c '
            if [ -f nexus-ai/backend/pyproject.toml ]; then
              cd nexus-ai/backend
              python -m pip install --upgrade pip
              pip install uv
              uv pip install . || true
            fi
            if [ -f nexus-ai/frontend/package.json ]; then
              cd nexus-ai/frontend
              npm ci || true
            fi'
          plugin_licenses_legal: yes
          plugin_licenses_ratio: yes
          retries: 3
          optimize: svg
          verify: yes
