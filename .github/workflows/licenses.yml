name: Generate Licenses

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  metrics:
    name: "Generate License Metrics"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout nexus-ai repository
        uses: actions/checkout@v4
        with:
          repository: Yungshween/nexus-ai
          token: ${{ secrets.NEXUS_PAT }}
          path: nexus-ai

      - name: "License Graphic"
        uses: lowlighter/metrics@latest
        env:
          GH_TOKEN: ${{ secrets.NEXUS_PAT }}
        with:
          filename: docs/assets/images/metrics/metrics.plugin.licenses.ratio.svg
          token: ${{ secrets.NEXUS_PAT }}
          base: ""
          user: Yungshween
          repo: nexus-ai
          template: repository
          plugin_licenses: yes
          committer_token: ${{ secrets.NEXUS_PAT }}
          plugin_licenses_setup: |
            bash -c '
            cd nexus-ai
            if [ -f backend/pyproject.toml ]; then
              cd backend
              python -m pip install --upgrade pip
              pip install uv
              pip install -e .
            fi
            if [ -f frontend/package.json ]; then
              cd frontend
              npm ci
              npm run build
            fi'
          plugin_licenses_legal: yes
          plugin_licenses_ratio: yes
          retries: 3
          optimize: svg
          verify: yes
